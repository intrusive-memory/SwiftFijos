name: Tests

on:
  pull_request:
    branches: [main, development]

jobs:
  test-macos:
    name: Test on macOS
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Build for macOS
        run: swift build

      - name: Run macOS tests
        run: swift test --enable-code-coverage 2>&1 | tee test-output-macos.log

      - name: Generate coverage report
        run: |
          # Get the build path
          BUILD_PATH=$(swift build --show-bin-path)
          XCTEST_PATH=$(find $BUILD_PATH -name "*.xctest" | head -n 1)

          # Find the profdata file
          PROFDATA_PATH=$(find .build -name "*.profdata" | head -n 1)

          if [ -f "$PROFDATA_PATH" ]; then
            echo "Found profdata at: $PROFDATA_PATH"

            # Generate coverage report
            xcrun llvm-cov report \
              "$XCTEST_PATH/Contents/MacOS/"* \
              -instr-profile="$PROFDATA_PATH" \
              -ignore-filename-regex=".build|Tests" \
              > coverage-report.txt

            echo "Coverage report generated"
            cat coverage-report.txt
          else
            echo "No profdata file found"
          fi

      - name: Upload macOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-macos
          path: |
            test-output-macos.log
            coverage-report.txt
          retention-days: 30

  test-ios:
    name: Test on iOS Simulator
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Build for iOS Simulator
        run: |
          xcodebuild build-for-testing \
            -scheme SwiftFijos \
            -destination 'platform=iOS Simulator,name=iPhone 17,OS=26.1' \
            -enableCodeCoverage YES

      - name: Run iOS Simulator tests
        run: |
          xcodebuild test-without-building \
            -scheme SwiftFijos \
            -destination 'platform=iOS Simulator,name=iPhone 17,OS=26.1' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            2>&1 | tee test-output-ios.log

      - name: Upload iOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-ios
          path: |
            test-output-ios.log
            TestResults.xcresult
          retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-macos, test-ios]
    if: always()

    steps:
      - name: Download macOS results
        uses: actions/download-artifact@v4
        with:
          name: test-results-macos
          path: macos-results

      - name: Download iOS results
        uses: actions/download-artifact@v4
        with:
          name: test-results-ios
          path: ios-results

      - name: Generate summary
        run: |
          echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # macOS Results
          echo "## macOS Tests" >> $GITHUB_STEP_SUMMARY
          if [ -f macos-results/test-output-macos.log ]; then
            if grep -q "Test run with.*passed" macos-results/test-output-macos.log; then
              MACOS_RESULT=$(grep "Test run with" macos-results/test-output-macos.log | tail -1)
              echo "✅ $MACOS_RESULT" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Tests failed - check logs" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No macOS test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # iOS Results
          echo "## iOS Simulator Tests" >> $GITHUB_STEP_SUMMARY
          if [ -f ios-results/test-output-ios.log ]; then
            if grep -q "Test session.*passed" ios-results/test-output-ios.log; then
              echo "✅ Tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Tests failed - check logs" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No iOS test results found" >> $GITHUB_STEP_SUMMARY
          fi

          # Coverage
          if [ -f macos-results/coverage-report.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
            COVERAGE=$(grep -oE '[0-9]+\.[0-9]+%' macos-results/coverage-report.txt | head -n 1)
            if [ -n "$COVERAGE" ]; then
              echo "**Overall Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
            fi
          fi
